# DN42 快速配置指南

## 功能概述

这个增强版的DN42快速脚本支持本地存储用户配置，大大简化了后续对端连接的建立过程。

## 核心功能

### 1. 用户配置管理
- 本地存储ASN号码
- 本地存储WireGuard私钥和监听端口
- 本地存储DN42 IP地址和网段信息
- 支持IPv4和IPv6配置

### 2. 对端配置管理
- 自动保存对端信息
- 支持查看、删除已保存的对端
- 重复使用已保存的对端配置

### 3. 快速模式
- 初始化后只需要输入对端信息
- 自动生成WireGuard和BGP配置文件
- 自动启用服务和重载配置

## 使用步骤

### 首次使用（初始化）

1. 运行主程序：
   ```bash
   python3 bash.py
   ```

2. 选择 "6. 初始化用户配置"

3. 按提示输入你的信息：
   - ASN号码 (例如: AS4242420123)
   - WireGuard私钥
   - DN42 IPv4地址 (例如: 172.20.123.1)
   - WireGuard监听端口 (例如: 20123)
   - 可选：IPv6地址、网段信息等

4. 配置保存后，主菜单会显示 "✓ 已配置用户信息"

### 创建新的BGP会话（快速模式）

1. 选择 "2. 创建新的BGP会话"

2. 系统检测到已有配置，进入快速模式

3. 只需要输入对端信息：
   - BGP会话名称 (例如: peer1)
   - 对方的ASN (例如: AS4242420456)
   - 对方的DN42 IP (例如: 172.20.456.1)
   - 对方的WireGuard公钥
   - 对方的WireGuard监听地址 (例如: peer.example.com:20456)

4. 系统自动：
   - 生成WireGuard配置文件
   - 生成BGP配置文件
   - 启用WireGuard服务
   - 重载BIRD配置

### 管理已保存的配置

- 选择 "7. 查看用户配置" 查看当前用户配置
- 选择 "8. 管理对端配置" 管理已保存的对端

## 配置文件

用户配置保存在 `dn42_config.yaml` 文件中，包含：

```yaml
user_info:
  asn: AS4242420123
  private_key: your_private_key_here
  dn42_ip: 172.20.123.1
  listen_port: '20123'
  dn42_ipv6: fd42:4242:4242:123::1
  net_segment: 172.20.123.0/24
  net_segment_v6: fd42:4242:4242:123::/64

peers:
  peer1:
    asn: AS4242420456
    public_key: peer_public_key_here
    endpoint: peer.example.com:20456
    dn42_ip: 172.20.456.1
```

## 向后兼容

如果没有保存用户配置或选择不使用保存的配置，脚本会退回到传统模式，每次都要求输入完整信息。

## 安全注意事项

- 配置文件包含敏感信息（私钥），请妥善保管
- 建议设置适当的文件权限：`chmod 600 dn42_config.yaml`
- 查看配置时，私钥会被部分遮盖显示

## 故障排除

1. **权限问题**: 如果无法写入 `/etc/wireguard/` 或 `/etc/bird/`，请确保有足够权限
2. **配置错误**: 使用 "7. 查看用户配置" 检查保存的信息是否正确
3. **重置配置**: 删除 `dn42_config.yaml` 文件可以重新开始初始化